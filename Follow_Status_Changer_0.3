// ==UserScript==
// @name         Follow Status Changer
// @namespace    http://tampermonkey.net/
// @version      0.3
// @description  ã€Œå…¬é–‹ãƒ•ã‚©ãƒ­ãƒ¼ã€ã‚’ã€Œéå…¬é–‹ãƒ•ã‚©ãƒ­ãƒ¼ã€ã«å¤‰æ›ã™ã‚‹
// @author       Ameba Blog User
// @match        https://blog.ameba.jp/ucs/blgfavorite/*
// @match        https://blog.ameba.jp/reader.do?bnm*
// @match        https://blog.ameba.jp/readerend.do*
// @grant        none
// ==/UserScript==


if(document.querySelector('#readerList')){ // ãƒ•ã‚©ãƒ­ãƒ¼ç®¡ç†ãƒšãƒ¼ã‚¸ã§æœ‰åŠ¹

    let converted; // å‡¦ç†ã—ãŸIDã®é…åˆ—
    let read_json=localStorage.getItem('FSC_converted'); // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å
    converted=JSON.parse(read_json);
    if(converted==null){
        converted=[]; } // å¤‰æ›å‡¦ç†ã—ãŸIDã®é…åˆ—
    write_local(); //ğŸ”´


    function write_local(){
        converted=Array.from(new Set(converted));
        let write_json=JSON.stringify(converted);
        localStorage.setItem('FSC_converted', write_json); } // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ä¿å­˜



    status();

    function status(){ //ã€Œå…¬é–‹ãƒ•ã‚©ãƒ­ãƒ¼ã€ã‚’ã€Œéå…¬é–‹ã€ã«å¤‰æ›´
        let k;
        let blog_id=[];
        let status_span=[];
        let del_button=[];
        let blog_name=document.querySelectorAll('input[name="blog_name"]');
        let table_tr=document.querySelectorAll('.tableList tbody tr');

        let info=
            '<div class="info">ã€Œæ‰¿èªæ¸ˆã¿ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨'+
            'ã€Œå…¬é–‹ãƒ•ã‚©ãƒ­ãƒ¼ã€ã‚’ã€Œéå…¬é–‹ãƒ•ã‚©ãƒ­ãƒ¼ã€ã«è‡ªå‹•çš„ã«å¤‰æ›´ã—ã¾ã™ã€€ã€€'+
            '<button id="fsc_log" type="button">Convert Check</button>'+
            '<style>.info { font-family: inherit; font-size: 12px; margin: 6px 0 -12px; '+
            'padding: 2px 6px 1px; color: #fff; background: #2196f3; } '+
            '.tableList .open { padding: 4px 8px 3px 8px !important; border: 1px solid #ccc; '+
            'border-radius: 4px; background: rgb(195 226 236); cursor: pointer; } '+
            '</style></div>';

        let box=document.querySelector('#ucsMainLeft #notes');
        if(!box.querySelector('.info')){
            box.insertAdjacentHTML('beforeend', info); }



        let open_id=sessionStorage.getItem('FSC'); //ğŸ”µ
        if(open_id){
            if(open_id!=0){ // æœªå‡¦ç†ãªã‚‰å®Ÿè¡Œ
                setTimeout(()=>{
                    sessionStorage.setItem('FSC', 0); //ğŸ”µ
                    let follow_url='https://blog.ameba.jp/reader.do?bnm=' + open_id + '&status=close';
                    let subwin=window.open( follow_url );
                }, 20); }}



        for(k=0; k<table_tr.length; k++){
            blog_id[k]=blog_name[k].getAttribute('value');
            del_button[k]=table_tr[k].querySelector('.btnDelete');
            status_span[k]=table_tr[k].querySelector('.status span');
            if(status_span[k].classList.contains('open')==true){
                win_open(status_span[k], blog_id[k], del_button[k]); }}


        function win_open(span, id, del){ // å…¬é–‹â†’éå…¬é–‹ã®è‡ªå‹•å¤‰æ›´
            span.onclick=function(){
                converted.push(id);
                write_local(); //ğŸ”´
                del.click();
                setTimeout(()=>{ // å¯¾è±¡ãƒ–ãƒ­ã‚°ã®å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™
                    let ok=document.querySelector('.minimumApplyButton a:first-child');
                    if(ok){
                        sessionStorage.setItem('FSC', id); //ğŸ”µ
                        ok.click();
                    }}, 20); }

        } // win_open()



        let fsc_log=document.querySelector('#fsc_log');
        if(fsc_log){
            fsc_log.onclick=function(){
                let read_json=localStorage.getItem('FSC_converted'); // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å
                converted=JSON.parse(read_json); //ğŸ”´

                let tmp=[];
                for(let k=0; k<converted.length; k++){
                    if(!blog_id.includes(converted[k])){
                        tmp.push(converted[k]); }} // å¤‰æ›å±¥æ­´ã§ãƒªã‚¹ãƒˆã«ç„¡ã„ã‚‚ã®ã‚’æŠ½å‡º
                converted=tmp;
                write_local(); // æŠ½å‡ºçµæœã‚’ä¿å­˜

                if(converted.length==0){
                    alert("å¤‰æ›å‡¦ç†ã§å¤±ã‚ã‚ŒãŸç™»éŒ²ãƒ–ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“"); }
                else{
                    if(!document.querySelector('#rest')){
                        disp_list(); }
                    else{
                        document.querySelector('#rest').remove(); }}


                function disp_list(){
                    let disp=
                        '<div id="rest">'+
                        '<div class="r_div">å¤‰æ›å‡¦ç†å¾Œã«æœªç¢ºèªã®ãƒ–ãƒ­ã‚°ã§ã™ã€‚ã“ã®ãƒªã‚¹ãƒˆãŒç„¡ããªã‚‹ã¾ã§'+
                        'ä»–ã®ãƒšãƒ¼ã‚¸ã‚‚ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„</div>'+
                        '<ul class="r_ul"></ul>'+
                        '<style>'+
                        '#rest { position: fixed; top: 240px; right: 15px; z-index: 200; '+
                        'font: normal 16px/28px Meiryo; padding: 20px; border: 1px solid #119e28; '+
                        'background: #fff; width: 200px; max-height: 300px; overflow-y: scroll; } '+
                        '.r_div { font-size: 14px; line-height: 18px; margin: 0 0 12px; } '+
                        '.r_ul li { border-bottom: 1px solid #ddd; white-space: nowrap; '+
                        'overflow-x: auto; scrollbar-width: none; } '+
                        '.r_ul li a { color: #000; } '+
                        '</style></div>';

                    if(!document.querySelector('#rest')){
                        document.body.insertAdjacentHTML('beforeend', disp); }

                    let r_ul=document.querySelector('.r_ul');
                    if(r_ul){
                        for(let k=0; k<converted.length; k++){
                            let item=
                                '<li><a target="_blank" href="https://ameblo.jp/'+
                                converted[k] +'/">'+ converted[k] +'</a></li>';
                            r_ul.insertAdjacentHTML('beforeend', item); }}
                } // disp_list()
            }
        }

    } // status()

} // ãƒ•ã‚©ãƒ­ãƒ¼ç®¡ç†ãƒšãƒ¼ã‚¸ã§æœ‰åŠ¹




if(document.querySelector('#header.rd-header')){ // ãƒ•ã‚©ãƒ­ãƒ¼ç™»éŒ²ç”»é¢ã§æœ‰åŠ¹

    changer();

    function changer(){
        let win_url=window.location.search.substring(1,window.location.search.length);
        if(win_url.indexOf('status=close')!=-1){
            if(!document.querySelector('.rd-error._whole .error')){ // æœªãƒ•ã‚©ãƒ­ãƒ¼ã®çŠ¶æ…‹
                document.querySelector('#secInValidateNumber_01').checked=true; // éå…¬é–‹ã‚’é¸æŠ
                setTimeout(()=>{
                    document.querySelector('.rd-btnSubmit').click(); //ã€Œãƒ•ã‚©ãƒ­ãƒ¼ã€æ±ºå®šãƒœã‚¿ãƒ³ã‚’æŠ¼ã™
                }, 40); }
            else{ // ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã‚‹çŠ¶æ…‹ï¼ˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒæ—©éããŸå ´åˆï¼‰
                if(sessionStorage.getItem('FSC_reload')!=0){ //ğŸ”µ
                    sessionStorage.setItem('FSC_reload', 0); //ğŸ”µ ä¸€åº¦ã ã‘ãƒªãƒ­ãƒ¼ãƒ‰
                    setTimeout(()=>{
                        location.reload();
                    }, 200); }}}
        else{
            if(location.pathname=='/readerend.do'){ // å‡¦ç†çµ‚äº†ç”»é¢ã®å ´åˆ
                if(!document.querySelector('.rd-error._whole .error')){
                    window.opener.location.reload(); // ä¸»ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã®å…ƒãƒšãƒ¼ã‚¸ã‚’é–‹ã
                    window.close(); // å‡¦ç†ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹
                }
                else{
                    // ä¸æ­£æ¤œçŸ¥ã¨åˆ¤å®šã•ã‚ŒãŸå ´åˆã¯ã€å‡¦ç†ã‚’åœæ­¢
                }
            }}

    } // change()

} // ãƒ•ã‚©ãƒ­ãƒ¼ç™»éŒ²ç”»é¢ã§æœ‰åŠ¹
